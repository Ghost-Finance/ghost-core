<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/UpdateHouse.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> UpdateHouse.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>75/75</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">72.73% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>16/22</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>76/76</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
&nbsp;
import './oracle/GSpot.sol';
import './base/CoreMath.sol';
import './DebtPool.sol';
import './GTokenERC20.sol';
import './PositionVault.sol';
import 'hardhat/console.sol';
import "@openzeppelin/contracts/access/Ownable.sol";
&nbsp;
contract UpdateHouse is CoreMath, Ownable {
&nbsp;
  using SafeMath for uint256;
&nbsp;
  GTokenERC20 public token;
  GSpot public spot;
  DebtPool public debtPool;
  PositionVault public vault;
  address staker;
&nbsp;
  enum Direction{ UNSET, SHORT, LONG }
  enum Status { UNSET, OPEN, FINISHED }
&nbsp;
  struct PositionData {
    address account;
    Direction direction;
    Status status;
    bytes32 synth;
    uint256 averagePrice;
    uint256 lastSynthPrice;
    uint256 tokenAmount;
    uint256 synthTokenAmount;
    uint256 created_at;
    uint256 updated_at;
  }
&nbsp;
  uint positionCount;
&nbsp;
  mapping (uint =&gt; PositionData) public data;
&nbsp;
  event Create(address account, PositionData data);
  event Finish(address account, Direction direction, Status status);
  event Increase(address account, PositionData data);
  event Decrease(address account, PositionData data);
  event Winner(address account, uint256 amount);
  event Loser(address account, uint256 amount);
&nbsp;
  constructor(GTokenERC20 token_, GSpot spot_, DebtPool debtPool_) {
    token = GTokenERC20(token_);
    spot = GSpot(spot_);
    debtPool = DebtPool(debtPool_);
  }
&nbsp;
  function setVault() public onlyOwner {
    vault = new PositionVault(token, address(this));
  }
&nbsp;
  function getVault() public view returns (address) {
    return address(vault);
  }
&nbsp;
  function createPosition(uint256 amount, bytes32 synthKey, Direction direction_) external {
    require(amount &gt; 0, 'Invalid amount');
    require(direction_ == Direction.SHORT || direction_ == Direction.LONG, "Invalid position option");
&nbsp;
    uint256 initialPrice = spot.read(synthKey);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(initialPrice &gt; 0);
&nbsp;
    PositionData memory dataPosition = _create(msg.sender, direction_, synthKey, initialPrice, amount);
    _addPositionVault(positionCount, address(msg.sender), amount);
&nbsp;
    emit Create(msg.sender, dataPosition);
  }
&nbsp;
  function increasePosition(uint index, uint256 deltaAmount) external {
    PositionData storage dataPosition = data[index];
    <span class="missing-if-branch" title="else path not taken" >E</span>require(dataPosition.account == msg.sender &amp;&amp; dataPosition.status != Status.FINISHED);
    uint256 currentPrice = spot.read(dataPosition.synth);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(currentPrice &gt; 0, 'Invalid synth price');
    _addPositionVault(index, address(msg.sender), deltaAmount);
&nbsp;
    uint256 newSynthTokenAmount = mul(deltaAmount, WAD).div(currentPrice);
    uint256 oldSynthPrice = div(dataPosition.synthTokenAmount.mul(dataPosition.averagePrice), WAD);
    uint256 newSynthPrice = div(newSynthTokenAmount.mul(currentPrice), WAD);
    uint256 averagePrice = div(mul(newSynthPrice.add(oldSynthPrice), WAD), dataPosition.synthTokenAmount.add(newSynthTokenAmount));
&nbsp;
    dataPosition.averagePrice = averagePrice;
    dataPosition.tokenAmount += deltaAmount;
    dataPosition.synthTokenAmount = newSynthTokenAmount;
    emit Increase(msg.sender, dataPosition);
  }
&nbsp;
  function decreasePosition(uint index, uint256 deltaAmount) external {
    PositionData storage dataPosition = data[index];
    <span class="missing-if-branch" title="else path not taken" >E</span>require(dataPosition.account == msg.sender &amp;&amp; dataPosition.status != Status.FINISHED);
    uint256 currentPrice = spot.read(dataPosition.synth);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(currentPrice &gt; 0, 'Invalid synth price');
&nbsp;
    int positionFixValue = getPositionFix(dataPosition.direction, dataPosition.synthTokenAmount, currentPrice, dataPosition.lastSynthPrice);
    uint256 oldTokenAmount = uint(int(dataPosition.tokenAmount) + positionFixValue);
    uint256 newTokenAmount = oldTokenAmount.sub(deltaAmount);
    uint256 newSynthTokenAmount = div(newTokenAmount.mul(dataPosition.synthTokenAmount), oldTokenAmount);
    uint256 tokenAmount = uint(int(newTokenAmount) - positionFixValue);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(tokenAmount == deltaAmount);
&nbsp;
    dataPosition.tokenAmount -= tokenAmount;
    dataPosition.averagePrice = (newTokenAmount * WAD).div(newSynthTokenAmount);
    dataPosition.synthTokenAmount = newSynthTokenAmount;
    dataPosition.lastSynthPrice = currentPrice;
&nbsp;
    _removePositionVault(index, address(msg.sender), tokenAmount);
&nbsp;
    emit Decrease(msg.sender, dataPosition);
  }
&nbsp;
  function finishPosition(uint index) external {
    PositionData storage dataPosition = data[index];
    require(dataPosition.account == msg.sender &amp;&amp; dataPosition.status != Status.FINISHED, 'Invalid account or position already finished!');
    uint256 currentPrice = spot.read(dataPosition.synth);
    require(currentPrice &gt; 0, 'Current price not valid!');
&nbsp;
    int positionFixValue = getPositionFix(dataPosition.direction,
                                          dataPosition.synthTokenAmount,
                                          currentPrice,
                                          dataPosition.lastSynthPrice);
&nbsp;
    uint256 currentPricePosition = uint(int(dataPosition.tokenAmount) + positionFixValue);
&nbsp;
    uint256 amount = vault.withdrawFullDeposit(index);
    uint256 amountToReceive;
    if (currentPricePosition &gt;= dataPosition.tokenAmount) {
      console.log("vai mintar");
      amountToReceive = currentPricePosition - dataPosition.tokenAmount;
      debtPool.mint(amountToReceive);
&nbsp;
      vault.transferFrom(address(msg.sender), amount);
      debtPool.transferFrom(address(msg.sender), amountToReceive);
&nbsp;
      emit Winner(address(msg.sender), amount + amountToReceive);
    } else {
      console.log("vai burnar");
      amountToReceive = amount - currentPricePosition;
      vault.transferFrom(address(debtPool), amountToReceive);
      debtPool.burn(amountToReceive);
      vault.transferFrom(address(msg.sender), currentPricePosition);
&nbsp;
      emit Loser(address(msg.sender), currentPricePosition);
    }
&nbsp;
    dataPosition.status = Status.FINISHED;
    dataPosition.updated_at = block.timestamp;
    data[index] = dataPosition;
&nbsp;
    emit Finish(address(msg.sender), dataPosition.direction, dataPosition.status);
  }
&nbsp;
  function _create(address account, Direction direction, bytes32 synthKey, uint256 price, uint256 amount) internal returns (PositionData memory) {
    PositionData memory dataPosition = PositionData(
      address(account),
      direction,
      Status.OPEN,
      synthKey,
      price,
      price,
      amount,
      radiv(amount, price),
      block.timestamp,
      block.timestamp
    );
    positionCount++;
    data[positionCount] = dataPosition;
&nbsp;
    return dataPosition;
  }
&nbsp;
  function getPositionFix(Direction direction, uint256 synthTokenAmount, uint256 currentTokenSynthAmount, uint256 lastTokenSynthAmount) public returns (int) {
    uint256 newPrice = synthTokenAmount.mul(currentTokenSynthAmount) / WAD;
    uint256 oldPrice = synthTokenAmount.mul(lastTokenSynthAmount) / WAD;
&nbsp;
    int result = int(newPrice) - int(oldPrice);
&nbsp;
    return result * (direction == Direction.SHORT ? int(-1) : int(1));
  }
&nbsp;
  function _addPositionVault(uint index, address account, uint amount) internal {
    vault.addDeposit(index, account, amount);
  }
&nbsp;
  function _removePositionVault(uint index, address account, uint amount) internal {
    vault.removeDeposit(index, account, amount);
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Feb 19 2022 19:22:37 GMT-0300 (Brasilia Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
